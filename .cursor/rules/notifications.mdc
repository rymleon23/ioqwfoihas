# Rule: notifications

## Scope

Applies to in-app notifications, email digests, Slack (vNext), and the activity log. This rule explains how to emit notifications, debounce noisy events, and capture an auditable history.

## Instructions

* Build notifications for events such as task creation, state changes, assignee or due date updates, new comments, new attachments, scheduled post status changes, `@user` mentions, and rule-driven alerts (for example, triage queue thresholds).
* When an event fires, the Notification service creates an object with `id`, `recipientId`, `content`, `type` (in-app or email), `read`, and `createdAt`.
* In-app notifications appear under the bell icon with a badge count. Emails are delivered via the mail provider (SendGrid, SES, etc.).
* Debounce high-frequency changes. If multiple updates occur for the same task in a short window, batch them into a single notification sent after the configured delay.
* Prepare digest emails that summarize unread notifications daily or weekly (roadmap for vNext).

## Activity log

* Record every important action (create, update, delete) in the Activity log with `{ id, actorId, entityType, entityId, action, timestamp, changes }`.
* Surface Activity entries on Task, Project, and Strategic pages with filters for action type (status changes, comments, file attachments).
* Future audit logging requirements target SOC 2 compliance; keep payloads immutable.

## Contracts

* API `GET /notifications` returns paginated notifications and supports filtering by read state.
* API `PATCH /notifications/{id}` marks a notification as read. Provide a bulk "mark all" option.
* The Notification service depends on the scheduler module to send digest emails on cron jobs.
* Only show Activity entries to users who have permission to see the related entity.
* Validate mentioned users belong to the workspace before sending `@user` notifications.

## Anti-patterns

* Do not send an email for every event; only email when the user opted in or when the event is high priority.
* Do not mutate Activity log entries after they are written; treat them as immutable records for auditing.

